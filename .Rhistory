<<<<<<< HEAD
e$i <- e$i + 1
if(is.character(x)) x <- get(x)
if(is.character(y)) y <- get(y)
names.x <- names(x)
names.y <- names(y)
names(y)[names.y %chin% names.x & ! names.y %chin% by] <- paste0(names.y[names.y %chin% names.x & ! names.y %chin% by], '_', i) #the variables with same names but not 'by' variables will be renamed
res <- merge(x, y, by = by, all = all, all.x = all.x, all.y = all.y, )
res
}, objs)
=======
recode <- strsplit(term, '=')[[1]][1]
if(recode %like% '<-<'){
lo <- valid(strsplit(recode, '<-<')[[1]][1])
hi <- valid(strsplit(recode, '<-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var < hi] <- target
}else if(recode %like% '<-'){
lo <- valid(strsplit(recode, '<-')[[1]][1])
hi <- valid(strsplit(recode, '<-')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var <= hi] <- target
}else if(recode %like% '-<'){
lo <- valid(strsplit(recode, '-<')[[1]][1])
hi <- valid(strsplit(recode, '-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo <= var & var < hi] <- target
}else if(recode %like% '--'){
lo <- valid(strsplit(recode, '--')[[1]][1])
hi <- valid(strsplit(recode, '--')[[1]][2])
if(lo > hi) stop(paste('error in', recode))
recode.res[lo <= var & var <= hi] <- target
}else if(recode %like% 'else'){
recode.res[] <- target
}else{
set <-valid(recode)
recode.res[var %in% set] <- target
}
}
if(as.factor.result | is.factor(var)){
if(!missing(levels)){
recode.res <- factor(recode.res, levels = levels)
}else{
recode.res <- factor(recode.res)
}
}
recode.res
}
recode(x, recodes = 'low--ymd("20150313")=1;else=2')
setkey
temp <- function(...)
{
res <- list(...)
res
}
temp(x, b, x)
temp('c', 'v')
temp(x, y)
recode <- function(var, recodes, as.factor.result = TRUE, levels, labels){
if(is.factor(var)) var <- as.character(var)
deal.time <- any(class(var) %like% 'POSIX')
recodes <- str_replace_all(recodes, '\n|\t| ', '')
recode.list <- rev(strsplit(recodes, split = ';')[[1]])
if(deal.time){
low <- ymd('19000101')
high <- ymd('30000101')
}else{
low <- -Inf
high <- Inf
}
valid <- function(string){
res <- try(eval(parse(text = string)), silent = TRUE)
if(deal.time){
if(is.na(res)) stop('\n  ', string, ' is invalid')
}else{
if (class(res) == 'try-error') stop('\n  ', string, ' is invalid')
}
res
}
if(deal.time) recode.res <- vector(mode = 'character', length = length(var))
else recode.res <- var
for(term in recode.list){
#target <- valid(strsplit(term, '=')[[1]][2])
target <- strsplit(term, '=')[[1]][2]
recode <- strsplit(term, '=')[[1]][1]
if(recode %like% '<-<'){
lo <- valid(strsplit(recode, '<-<')[[1]][1])
hi <- valid(strsplit(recode, '<-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var < hi] <- target
}else if(recode %like% '<-'){
lo <- valid(strsplit(recode, '<-')[[1]][1])
hi <- valid(strsplit(recode, '<-')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var <= hi] <- target
}else if(recode %like% '-<'){
lo <- valid(strsplit(recode, '-<')[[1]][1])
hi <- valid(strsplit(recode, '-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo <= var & var < hi] <- target
}else if(recode %like% '--'){
lo <- valid(strsplit(recode, '--')[[1]][1])
hi <- valid(strsplit(recode, '--')[[1]][2])
if(lo > hi) stop(paste('error in', recode))
recode.res[lo <= var & var <= hi] <- target
}else if(recode %like% 'else'){
recode.res[] <- target
}else{
set <-valid(recode)
recode.res[var %in% set] <- target
}
}
recode.res.text <- paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', substitute(levels))),
ifelse(missing(labels), '', paste0(',labels=', substitute(labels))),
')')
eval(parse(text = recode))
}
recode(x, recodes = 'low--ymd("20150313")=1;else=2')
recode(x, recodes = 'low--ymd("20150313")=1;else=2')
recode(x, recodes = 'low--ymd("20150313")=1;else=2')
recode <- function(var, recodes, as.factor.result = TRUE, levels, labels){
if(is.factor(var)) var <- as.character(var)
deal.time <- any(class(var) %like% 'POSIX')
recodes <- str_replace_all(recodes, '\n|\t| ', '')
recode.list <- rev(strsplit(recodes, split = ';')[[1]])
if(deal.time){
low <- ymd('19000101')
high <- ymd('30000101')
}else{
low <- -Inf
high <- Inf
}
valid <- function(string){
res <- try(eval(parse(text = string)), silent = TRUE)
if(deal.time){
if(is.na(res)) stop('\n  ', string, ' is invalid')
}else{
if (class(res) == 'try-error') stop('\n  ', string, ' is invalid')
}
res
}
if(deal.time) recode.res <- vector(mode = 'character', length = length(var))
else recode.res <- var
for(term in recode.list){
#target <- valid(strsplit(term, '=')[[1]][2])
target <- strsplit(term, '=')[[1]][2]
recode <- strsplit(term, '=')[[1]][1]
if(recode %like% '<-<'){
lo <- valid(strsplit(recode, '<-<')[[1]][1])
hi <- valid(strsplit(recode, '<-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var < hi] <- target
}else if(recode %like% '<-'){
lo <- valid(strsplit(recode, '<-')[[1]][1])
hi <- valid(strsplit(recode, '<-')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var <= hi] <- target
}else if(recode %like% '-<'){
lo <- valid(strsplit(recode, '-<')[[1]][1])
hi <- valid(strsplit(recode, '-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo <= var & var < hi] <- target
}else if(recode %like% '--'){
lo <- valid(strsplit(recode, '--')[[1]][1])
hi <- valid(strsplit(recode, '--')[[1]][2])
if(lo > hi) stop(paste('error in', recode))
recode.res[lo <= var & var <= hi] <- target
}else if(recode %like% 'else'){
recode.res[] <- target
}else{
set <-valid(recode)
recode.res[var %in% set] <- target
}
}
recode.res.text <- paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', substitute(levels))),
ifelse(missing(labels), '', paste0(',labels=', substitute(labels))),
')')
eval(parse(text = recode.res.text))
}
recode(x, recodes = 'low--ymd("20150313")=1;else=2')
recode(x, recodes = 'low--ymd("20150313")=1;else=2', levels = c(1, 2), labels = c('以前', '之后'))
temp <- function(x)
{
return(substitute(x))
}
temp(c(1, 2))
temp <- function(levels, labels)
{
paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', substitute(levels))),
ifelse(missing(labels), '', paste0(',labels=', substitute(labels))),
')')
}
temp(c(1, 2), c('1', '2'))
temp(levels = c(1, 2), labels = c('1', '2'))
temp <- function(levels, labels)
{
cat(substitute(levels), '\n')
paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', substitute(levels))),
ifelse(missing(labels), '', paste0(',labels=', substitute(labels))),
')')
}
temp(levels = c(1, 2), labels = c('1', '2'))
help(substitute)
temp <- function(levels, labels)
{
cat(quote(levels), '\n')
paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', substitute(levels))),
ifelse(missing(labels), '', paste0(',labels=', substitute(labels))),
')')
}
temp(levels = c(1, 2), labels = c('1', '2'))
temp <- function(levels, labels)
{
cat(quote(substitute(levels)), '\n')
paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', substitute(levels))),
ifelse(missing(labels), '', paste0(',labels=', substitute(labels))),
')')
}
temp(levels = c(1, 2), labels = c('1', '2'))
temp <- function(levels, labels)
{
print(quote(substitute(levels)))
paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', substitute(levels))),
ifelse(missing(labels), '', paste0(',labels=', substitute(labels))),
')')
}
temp(levels = c(1, 2), labels = c('1', '2'))
temp <- function(levels, labels)
{
print(substitute(levels))
paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', substitute(levels))),
ifelse(missing(labels), '', paste0(',labels=', substitute(labels))),
')')
}
temp(levels = c(1, 2), labels = c('1', '2'))
str(1)
temp <- function(levels, labels)
{
paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', as.character(substitute(levels)))),
ifelse(missing(labels), '', paste0(',labels=', as.character(substitute(labels)))),
')')
}
temp(levels = c(1, 2), labels = c('1', '2'))
class(substitute('1<2'))
temp <- function(levels, labels)
{
levels <- substitute(levels)
print(levels)
paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', as.character(substitute(levels)))),
ifelse(missing(labels), '', paste0(',labels=', as.character(substitute(labels)))),
')')
}
temp(levels = c(1, 2), labels = c('1', '2'))
temp <- function(levels, labels)
{
levels <- substitute(levels)
print(levels)
paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', levels)),
ifelse(missing(labels), '', paste0(',labels=', as.character(substitute(labels)))),
')')
}
temp(levels = c(1, 2), labels = c('1', '2'))
levels <- c(1, 2)
substitute(lelvels)
substitute(levels)
levels <- substitute('c(1, 2')
levels <- substitute('c(1, 2)')
levels
enquote(a == a)
quote(a == a)
temp <- function(levels, labels)
{
levels <- substitute(levels)
print(class(levels))
paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', levels)),
ifelse(missing(labels), '', paste0(',labels=', as.character(substitute(labels)))),
')')
}
temp(levels = c(1, 2), labels = c('1', '2'))
help(call)
str(substitute("1:2"))
str(substitute(1:2))
??language
class(substitute(1:2))
substitute(substitute(1:2))
names(c(1, 2))
all.names(expression(sin(x+y)))
all.names(substitute('c(1, 2)'))
help(all.names)
all.names(expression(substitute('c(1, 2)')))
all.names(substitute(c(1, 2)))
all.names(expression(c(1, 2)))
expression(c(1, 2))
eval(expression(c(1, 2)))
all.vars(expression(c(1, 2)))
help(parse)
quote(`foo bar`+1)
deparse(quote(`foo bar`+1))
temp <- function(levels, labels)
{
levels <- deparse(levels)
print(class(levels))
paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', levels)),
ifelse(missing(labels), '', paste0(',labels=', as.character(substitute(labels)))),
')')
}
temp(levels = c(1, 2), labels = c('1', '2'))
recode <- function(var, recodes, as.factor.result = TRUE, levels, labels){
if(is.factor(var)) var <- as.character(var)
deal.time <- any(class(var) %like% 'POSIX')
recodes <- str_replace_all(recodes, '\n|\t| ', '')
recode.list <- rev(strsplit(recodes, split = ';')[[1]])
if(deal.time){
low <- ymd('19000101')
high <- ymd('30000101')
}else{
low <- -Inf
high <- Inf
}
valid <- function(string){
res <- try(eval(parse(text = string)), silent = TRUE)
if(deal.time){
if(is.na(res)) stop('\n  ', string, ' is invalid')
}else{
if (class(res) == 'try-error') stop('\n  ', string, ' is invalid')
}
res
}
if(deal.time) recode.res <- vector(mode = 'character', length = length(var))
else recode.res <- var
for(term in recode.list){
#target <- valid(strsplit(term, '=')[[1]][2])
target <- strsplit(term, '=')[[1]][2]
recode <- strsplit(term, '=')[[1]][1]
if(recode %like% '<-<'){
lo <- valid(strsplit(recode, '<-<')[[1]][1])
hi <- valid(strsplit(recode, '<-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var < hi] <- target
}else if(recode %like% '<-'){
lo <- valid(strsplit(recode, '<-')[[1]][1])
hi <- valid(strsplit(recode, '<-')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var <= hi] <- target
}else if(recode %like% '-<'){
lo <- valid(strsplit(recode, '-<')[[1]][1])
hi <- valid(strsplit(recode, '-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo <= var & var < hi] <- target
}else if(recode %like% '--'){
lo <- valid(strsplit(recode, '--')[[1]][1])
hi <- valid(strsplit(recode, '--')[[1]][2])
if(lo > hi) stop(paste('error in', recode))
recode.res[lo <= var & var <= hi] <- target
}else if(recode %like% 'else'){
recode.res[] <- target
}else{
set <-valid(recode)
recode.res[var %in% set] <- target
}
}
recode.res.text <- paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', deparse(levels))),
ifelse(missing(labels), '', paste0(',labels=', deparse(labels))),
')')
eval(parse(text = recode.res.text))
}
recode(x, recodes = 'low--ymd("20150313")=1;else=2', levels = c(1, 2), labels = c('以前', '之后'))
recode(x, recodes = 'low--ymd("20150313")=1;else=2', levels = c(3, 2), labels = c('以前', '之后'))
recode(x, recodes = 'low--ymd("20150313")=1;else=2', levels = c(3, 2), labels = c('以前', '之后'), as.factor.result = F)
recode <- function(var, recodes, as.factor.result = TRUE, levels, labels){
if(is.factor(var)) var <- as.character(var)
deal.time <- any(class(var) %like% 'POSIX')
recodes <- str_replace_all(recodes, '\n|\t| ', '')
recode.list <- rev(strsplit(recodes, split = ';')[[1]])
if(deal.time){
low <- ymd('19000101')
high <- ymd('30000101')
}else{
low <- -Inf
high <- Inf
}
valid <- function(string){
res <- try(eval(parse(text = string)), silent = TRUE)
if(deal.time){
if(is.na(res)) stop('\n  ', string, ' is invalid')
}else{
if (class(res) == 'try-error') stop('\n  ', string, ' is invalid')
}
>>>>>>> 1b1bee011fd10f59d8fd846ec90715a3f2fde97c
res
}
if(deal.time) recode.res <- vector(mode = 'character', length = length(var))
else recode.res <- var
for(term in recode.list){
#target <- valid(strsplit(term, '=')[[1]][2])
target <- strsplit(term, '=')[[1]][2]
recode <- strsplit(term, '=')[[1]][1]
if(recode %like% '<-<'){
lo <- valid(strsplit(recode, '<-<')[[1]][1])
hi <- valid(strsplit(recode, '<-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var < hi] <- target
}else if(recode %like% '<-'){
lo <- valid(strsplit(recode, '<-')[[1]][1])
hi <- valid(strsplit(recode, '<-')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var <= hi] <- target
}else if(recode %like% '-<'){
lo <- valid(strsplit(recode, '-<')[[1]][1])
hi <- valid(strsplit(recode, '-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo <= var & var < hi] <- target
}else if(recode %like% '--'){
lo <- valid(strsplit(recode, '--')[[1]][1])
hi <- valid(strsplit(recode, '--')[[1]][2])
if(lo > hi) stop(paste('error in', recode))
recode.res[lo <= var & var <= hi] <- target
}else if(recode %like% 'else'){
recode.res[] <- target
}else{
set <-valid(recode)
recode.res[var %in% set] <- target
}
}
if(as.factor.result){
recode.res.text <- paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', deparse(levels))),
ifelse(missing(labels), '', paste0(',labels=', deparse(labels))),
')')
recode.res <- eval(parse(text = recode.res.text))
}
res
}
recode(x, recodes = 'low--ymd("20150313")=1;else=2', levels = c(3, 2), labels = c('以前', '之后'), as.factor.result = F)
recode <- function(var, recodes, as.factor.result = TRUE, levels, labels){
if(is.factor(var)) var <- as.character(var)
deal.time <- any(class(var) %like% 'POSIX')
recodes <- str_replace_all(recodes, '\n|\t| ', '')
recode.list <- rev(strsplit(recodes, split = ';')[[1]])
if(deal.time){
low <- ymd('19000101')
high <- ymd('30000101')
}else{
low <- -Inf
high <- Inf
}
valid <- function(string){
res <- try(eval(parse(text = string)), silent = TRUE)
if(deal.time){
if(is.na(res)) stop('\n  ', string, ' is invalid')
}else{
if (class(res) == 'try-error') stop('\n  ', string, ' is invalid')
}
res
}
if(deal.time) recode.res <- vector(mode = 'character', length = length(var))
else recode.res <- var
for(term in recode.list){
#target <- valid(strsplit(term, '=')[[1]][2])
target <- strsplit(term, '=')[[1]][2]
recode <- strsplit(term, '=')[[1]][1]
if(recode %like% '<-<'){
lo <- valid(strsplit(recode, '<-<')[[1]][1])
hi <- valid(strsplit(recode, '<-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var < hi] <- target
}else if(recode %like% '<-'){
lo <- valid(strsplit(recode, '<-')[[1]][1])
hi <- valid(strsplit(recode, '<-')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var <= hi] <- target
}else if(recode %like% '-<'){
lo <- valid(strsplit(recode, '-<')[[1]][1])
hi <- valid(strsplit(recode, '-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo <= var & var < hi] <- target
}else if(recode %like% '--'){
lo <- valid(strsplit(recode, '--')[[1]][1])
hi <- valid(strsplit(recode, '--')[[1]][2])
if(lo > hi) stop(paste('error in', recode))
recode.res[lo <= var & var <= hi] <- target
}else if(recode %like% 'else'){
recode.res[] <- target
}else{
set <-valid(recode)
recode.res[var %in% set] <- target
}
}
if(as.factor.result){
recode.res.text <- paste0('factor(recode.res',
ifelse(missing(levels), '', paste0(',levels=', deparse(levels))),
ifelse(missing(labels), '', paste0(',labels=', deparse(labels))),
')')
recode.res <- eval(parse(text = recode.res.text))
}
recode.res
}
recode(x, recodes = 'low--ymd("20150313")=1;else=2', levels = c(3, 2), labels = c('以前', '之后'), as.factor.result = F)
recode(-2:4, recodes = 'low--2=1;else=2')
head(vector)
help(vector)
vector(mode='any', 20)
vector(mode='character', 20)
library(process)
<<<<<<< HEAD
help(package = process)
data(iris)
library(data.table)
setDT(iris)
setkey(iris, Species)
temp <- unique(iris, by = 'Species')
tables()
duplicate <- function(data, by)
{
if(is.data.frame(data)) stop(substitute(data), 'is not data.frame!\n')
if (!is.data.table(data)) setDT(data)
if (is.integer(by)){
if (any(by > nrow(data)) | any(by < 1)) stop('Integer indexes are out of range\n',"It's often better to use colnames")
else by <- names(data)[by]
}else{
bad_cols <- setdiff(by, names(data))
if (length(bad_cols) > 0) stop(paste0(bad_cols, collapse = ','),'do not exist!')
}
setkey(data, by)
dup.rows <- unique(data[duplicated(data, by = by), by, with = F], by = by)
data[dup.rows, nomatch = 0]
}
duplicate(iris, by = c('Species'))
duplicate <- function(data, by)
{
if(!is.data.frame(data)) stop(substitute(data), ' is not data.frame!\n')
if (!is.data.table(data)) setDT(data)
if (is.integer(by)){
if (any(by > nrow(data)) | any(by < 1)) stop('Integer indexes are out of range\n',"It's often better to use colnames")
else by <- names(data)[by]
}else{
bad_cols <- setdiff(by, names(data))
if (length(bad_cols) > 0) stop(paste0(bad_cols, collapse = ','),'do not exist!')
}
setkey(data, by)
dup.rows <- unique(data[duplicated(data, by = by), by, with = F], by = by)
data[dup.rows, nomatch = 0]
}
duplicate(iris, by = c('Species'))
setkey(iris, 'Species')
by
setkey
duplicate <- function(data, by)
{
if(!is.data.frame(data)) stop(substitute(data), ' is not data.frame!\n')
if (!is.data.table(data)) setDT(data)
if (is.integer(by)){
if (any(by > nrow(data)) | any(by < 1)) stop('Integer indexes are out of range\n',"It's often better to use colnames")
else by <- names(data)[by]
}else{
bad_cols <- setdiff(by, names(data))
if (length(bad_cols) > 0) stop(paste0(bad_cols, collapse = ','),'do not exist!')
}
setkeyv(data, by)
dup.rows <- unique(data[duplicated(data, by = by), by, with = F], by = by)
data[dup.rows, nomatch = 0]
}
setkey(iris, 'Species')
duplicate(iris, by = c('Species'))
setkeyv
? %+%
%+%
`%+%`
help(`%+%`)
??%+%
'good' %+% 'gf'
setkey
x <- iris
`...` <- 'Species'
...
`...`
var <- 'Species'
cols = as.character(substitute(list(var))[-1])
cols
as.character(substitute(list('Species'))[-1])
as.character(substitute(list(c('Species', 'good')))[-1])
setkeyv(iris, cols = c('Species', 'Sepal.Length'))
tables()
help(setkeyv)
set2key
set2keyv
head(iris)
duplicate(iris, c('Petal.Width', 'Species'))
duplicate(iris, c('Petal.Width', 'Species', 'Petal.Width'))
duplicate(iris, c('Petal.Width', 'Species', 'Sepal.Width'))
duplicate <- function(data, by)
{
if(!is.data.frame(data)) stop(substitute(data), ' is not data.frame!\n')
if (!is.data.table(data)) setDT(data)
if (is.integer(by)){
if (any(by > nrow(data)) | any(by < 1)) stop('Integer indexes are out of range\n',"It's often better to use colnames")
else by <- names(data)[by]
}else{
bad_cols <- setdiff(by, names(data))
if (length(bad_cols) > 0) stop(paste0(bad_cols, collapse = ','),'do not exist!')
}
by <- unique(by)
setkeyv(data, by)
dup.rows <- unique(data[duplicated(data, by = by), by, with = F], by = by)
data[dup.rows, nomatch = 0]
}
duplicate(iris, c('Petal.Width', 'Species', 'Petal.Width'))
duplicate1 <- function(data, by)
{
if (!('package::data.table' %in% search())) require(data.table)
if (!is.data.table(data)) setDT(data)
if (is.integer(by)){
if (any(by > nrow(data)) | any(by < 1)) stop('Integer indexes are out of range\n',"It's often better to use colnames")
else by <- names(data)[by]
}else{
bad_cols <- setdiff(by, names(data))
if (length(bad_cols) > 0) stop(paste0(bad_cols, collapse = ','),'do not exist!')
}
dup.rows <- unique(data[duplicated(data, by = by), by, with = F], by = by)
res <- merge(data, dup.rows, by = by, all = F)
res
}
library(microbenchmark)
microbenchmark(duplicate(iris, c('Species', 'Petal.Width')), duplicate1(iris, c('Species', 'Petal.Width')))
iris <- iris[sample(1:150, 10000, replace = T)]
class(iris)
microbenchmark(duplicate(iris, c('Species', 'Petal.Width')), duplicate1(iris, c('Species', 'Petal.Width')))
iris <- as.data.frame(iris)
class(iris)
microbenchmark(duplicate(iris, c('Species', 'Petal.Width')), duplicate1(iris, c('Species', 'Petal.Width')))
duplicate <- function(data, by)
{
if(!is.data.frame(data)) stop(substitute(data), ' is not data.frame!\n')
if (!is.data.table(data)) setDT(data)
if (is.integer(by)){
if (any(by > nrow(data)) | any(by < 1)) stop('Integer indexes are out of range\n',"It's often better to use colnames")
else by <- names(data)[by]
}else{
bad_cols <- setdiff(by, names(data))
if (length(bad_cols) > 0) stop(paste0(bad_cols, collapse = ','),'do not exist!')
}
by <- unique(by)
setkeyv(data, by)
#dup.rows <- unique(data[duplicated(data, by = by), by, with = F], by = by)
dup.rows <- data[duplicated(data, by = by), by, with = F]
data[dup.rows, nomatch = 0]
}
microbenchmark(duplicate(iris, c('Species', 'Petal.Width')), duplicate1(iris, c('Species', 'Petal.Width')))
help(duplicated)
DT <- data.table(A = rep(1:3, each=4), B = rep(1:4, each=3), C = rep(1:2, 6), key = "A,B")
DT
anyDuplicated(DT, by=c("A", "B"))
duplicated(DT, by = c('A', 'B'))
library(stringr)
help(str_extract)
str_extract(string = 'good', 'o')
str_extract(string = 'good', 'O')
'o' %like% 'good'
'good' %like% 'o'
'good' %like% 'oo'
str_extract
eval(pasrse(text = '1<x<2'))
eval(parse(text = '1<x<2'))
eval(parse(text = '1<x & x<2'))
eval(parse(text = '1<xx & xx<2'))
help(stringr)
library(stringr)
help(package=stringr)
grep(pattern = '[0-9]', '123')
grep(pattern = '[0-9]', 'abd')
grepl(pattern = '[0-9]', 'abd')
grepl(pattern = '[0-9]', '234123')
help(grepl)
grepl(pattern = '[:digit:]', '234123')
grepl(pattern = '[:digits:]', '234123')
grepl(pattern = '[:digit:]', '234123')
grepl(pattern = [:digit:], '234123')
eval(parse(text = 'c(1, 2, 3)'))
eval(parse(text = '1, 2, 3'))
eval(parse(text = '1:4'))
strsplit('1;2;3', ';')
help(seq_along)
seq_along(1:4)
seq_along(10:4)
help(vector)
vector(10)
vector(mode = 'character', 10)
grepl(pattern = '[0-9]', '2g34123')
grepl(pattern = '[[:digit:]]', '2g34123')
vector(mode = 'character', 10)
vector(mode = 'character', 10) <- 2
vector(mode = 'character', 10) <- 1:10
cc <- vector(mode = 'character', 10)
cc <- 1:10
cc
recode <- function(var, recodes, deal.time = FALSE, as.factor.result = TRUE, levels){
is.fac <- is.factor(var)
if(is.fac) var <- as.character(var)
recodes <- str_replace_all(recodes, '\n|\t| ', '')
recode.list <- rev(strsplit(recodes, split = ';')[[1]])
if(deal.time){
low <- ymd('19000101')
high <- ymd('30000101')
}else{
low <- -Inf
high <- Inf
}
valid <- function(string){
res <- try(eval(parse(text = string)), silent = TRUE)
if(deal.time){
if(is.na(res)) stop('\n  ', string, ' is invalid')
}else{
if (class(res) == 'try-error') stop('\n  ', string, ' is invalid')
}
res
}
recode.res <- vector(mode = 'character', length = length(var))
for(term in recode.list){
#target <- valid(strsplit(term, '=')[[1]][2])
target <- strsplit(term, '=')[[1]][2]
recode <- strsplit(term, '=')[[1]][1]
if(recode %like% '<-<'){
lo <- valid(strsplit(recode, '<-<')[[1]][1])
hi <- valid(strsplit(recode, '<-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var < hi] <- target
}else if(recode %like% '<-'){
lo <- valid(strsplit(recode, '<-')[[1]][1])
hi <- valid(strsplit(recode, '<-')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var <= hi] <- target
}else if(recode %like% '-<'){
lo <- valid(strsplit(recode, '-<')[[1]][1])
hi <- valid(strsplit(recode, '-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo <= var & var < hi] <- target
}else if(recode %like% '--'){
lo <- valid(strsplit(recode, '--')[[1]][1])
hi <- valid(strsplit(recode, '--')[[1]][2])
if(lo > hi) stop(paste('error in', recode))
recode.res[lo <= var & var <= hi] <- target
}else if(recode %like% 'else'){
recode.res[] <- target
}else{
set <-valid(recode)
recode.res[var %in% set] <- target
}
}
if(as.factor.result | is.factor(var)){
if(missing(levels)){
recode.res <- factor(recode.res, levels = levels)
}else{
recode.res <- factor(recode.res)
}
}
recode.res
}
recode(1:10, '1:5=2;else=3')
recode(1:10, '1,5=2;else=3')
recode(1:10, 'c(1,5)=2;else=3')
recode(1:10, 'c(1,5)=2;c(2, 3)=3')
recode <- function(var, recodes, deal.time = FALSE, as.factor.result = TRUE, levels){
is.fac <- is.factor(var)
if(is.fac) var <- as.character(var)
recodes <- str_replace_all(recodes, '\n|\t| ', '')
recode.list <- rev(strsplit(recodes, split = ';')[[1]])
if(deal.time){
low <- ymd('19000101')
high <- ymd('30000101')
}else{
low <- -Inf
high <- Inf
}
valid <- function(string){
res <- try(eval(parse(text = string)), silent = TRUE)
if(deal.time){
if(is.na(res)) stop('\n  ', string, ' is invalid')
}else{
if (class(res) == 'try-error') stop('\n  ', string, ' is invalid')
}
res
}
if(deal.time) recode.res <- vector(mode = 'character', length = length(var))
else recode.res <- var
for(term in recode.list){
#target <- valid(strsplit(term, '=')[[1]][2])
target <- strsplit(term, '=')[[1]][2]
recode <- strsplit(term, '=')[[1]][1]
if(recode %like% '<-<'){
lo <- valid(strsplit(recode, '<-<')[[1]][1])
hi <- valid(strsplit(recode, '<-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var < hi] <- target
}else if(recode %like% '<-'){
lo <- valid(strsplit(recode, '<-')[[1]][1])
hi <- valid(strsplit(recode, '<-')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var <= hi] <- target
}else if(recode %like% '-<'){
lo <- valid(strsplit(recode, '-<')[[1]][1])
hi <- valid(strsplit(recode, '-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo <= var & var < hi] <- target
}else if(recode %like% '--'){
lo <- valid(strsplit(recode, '--')[[1]][1])
hi <- valid(strsplit(recode, '--')[[1]][2])
if(lo > hi) stop(paste('error in', recode))
recode.res[lo <= var & var <= hi] <- target
}else if(recode %like% 'else'){
recode.res[] <- target
}else{
set <-valid(recode)
recode.res[var %in% set] <- target
}
}
if(as.factor.result | is.factor(var)){
if(missing(levels)){
cat('good\n')
recode.res <- factor(recode.res, levels = levels)
}else{
recode.res <- factor(recode.res)
}
}
recode.res
}
recode(1:10, 'c(1,5)=2;else=3')
factor(1:3, levels = levels)
recode <- function(var, recodes, deal.time = FALSE, as.factor.result = TRUE, levels){
is.fac <- is.factor(var)
if(is.fac) var <- as.character(var)
recodes <- str_replace_all(recodes, '\n|\t| ', '')
recode.list <- rev(strsplit(recodes, split = ';')[[1]])
if(deal.time){
low <- ymd('19000101')
high <- ymd('30000101')
}else{
low <- -Inf
high <- Inf
}
valid <- function(string){
res <- try(eval(parse(text = string)), silent = TRUE)
if(deal.time){
if(is.na(res)) stop('\n  ', string, ' is invalid')
}else{
if (class(res) == 'try-error') stop('\n  ', string, ' is invalid')
}
res
}
if(deal.time) recode.res <- vector(mode = 'character', length = length(var))
else recode.res <- var
for(term in recode.list){
#target <- valid(strsplit(term, '=')[[1]][2])
target <- strsplit(term, '=')[[1]][2]
recode <- strsplit(term, '=')[[1]][1]
if(recode %like% '<-<'){
lo <- valid(strsplit(recode, '<-<')[[1]][1])
hi <- valid(strsplit(recode, '<-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var < hi] <- target
}else if(recode %like% '<-'){
lo <- valid(strsplit(recode, '<-')[[1]][1])
hi <- valid(strsplit(recode, '<-')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var <= hi] <- target
}else if(recode %like% '-<'){
lo <- valid(strsplit(recode, '-<')[[1]][1])
hi <- valid(strsplit(recode, '-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo <= var & var < hi] <- target
}else if(recode %like% '--'){
lo <- valid(strsplit(recode, '--')[[1]][1])
hi <- valid(strsplit(recode, '--')[[1]][2])
if(lo > hi) stop(paste('error in', recode))
recode.res[lo <= var & var <= hi] <- target
}else if(recode %like% 'else'){
recode.res[] <- target
}else{
set <-valid(recode)
recode.res[var %in% set] <- target
}
}
if(as.factor.result | is.factor(var)){
if(missing(levels)){
cat(levels)
recode.res <- factor(recode.res, levels = levels)
}else{
recode.res <- factor(recode.res)
}
}
recode.res
}
recode(1:10, 'c(1,5)=2;else=3')
recode <- function(var, recodes, deal.time = FALSE, as.factor.result = TRUE, levels){
is.fac <- is.factor(var)
if(is.fac) var <- as.character(var)
recodes <- str_replace_all(recodes, '\n|\t| ', '')
recode.list <- rev(strsplit(recodes, split = ';')[[1]])
if(deal.time){
low <- ymd('19000101')
high <- ymd('30000101')
}else{
low <- -Inf
high <- Inf
}
valid <- function(string){
res <- try(eval(parse(text = string)), silent = TRUE)
if(deal.time){
if(is.na(res)) stop('\n  ', string, ' is invalid')
}else{
if (class(res) == 'try-error') stop('\n  ', string, ' is invalid')
}
res
}
if(deal.time) recode.res <- vector(mode = 'character', length = length(var))
else recode.res <- var
for(term in recode.list){
#target <- valid(strsplit(term, '=')[[1]][2])
target <- strsplit(term, '=')[[1]][2]
recode <- strsplit(term, '=')[[1]][1]
if(recode %like% '<-<'){
lo <- valid(strsplit(recode, '<-<')[[1]][1])
hi <- valid(strsplit(recode, '<-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var < hi] <- target
}else if(recode %like% '<-'){
lo <- valid(strsplit(recode, '<-')[[1]][1])
hi <- valid(strsplit(recode, '<-')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo < var & var <= hi] <- target
}else if(recode %like% '-<'){
lo <- valid(strsplit(recode, '-<')[[1]][1])
hi <- valid(strsplit(recode, '-<')[[1]][2])
if(lo >= hi) stop(paste('error in', recode))
recode.res[lo <= var & var < hi] <- target
}else if(recode %like% '--'){
lo <- valid(strsplit(recode, '--')[[1]][1])
hi <- valid(strsplit(recode, '--')[[1]][2])
if(lo > hi) stop(paste('error in', recode))
recode.res[lo <= var & var <= hi] <- target
}else if(recode %like% 'else'){
recode.res[] <- target
}else{
set <-valid(recode)
recode.res[var %in% set] <- target
}
}
if(as.factor.result | is.factor(var)){
if(!missing(levels)){
recode.res <- factor(recode.res, levels = levels)
}else{
recode.res <- factor(recode.res)
}
}
recode.res
}
recode(1:10, 'c(1,5)=2;else=3')
recode(1:10, 'c(1,5)=2;else=3', levels = c(3))
library(denstyClust)
library(densityClust)
help(package=densityClust)
=======
help(package=process)
round(12345, 100)
round(1.098, 0.03)
library(process)
help
help(package=process)
>>>>>>> 1b1bee011fd10f59d8fd846ec90715a3f2fde97c
